%% Two state channel model with output Y given by (0/Unbound, 1/Bound) and
% input X given by (0/Low, 1/High).  
%
% Calculate the discrete time transition matrix, and bounds on the mutual
% information rates.  
%
% Background.  The mutual information rate is
%
% MI(X,Y) = H(X)+H(Y)-H(X,Y)
%
% We take X to be a Markov process with transition probabilities 
%
% X=0->X=1 w.pr. r (per time step)
% X=1->X=0 w.pr. s (per time step)
% 
% Therefore H(X) is a known function of r and s.
%
% The transition matrix for X is [r,1-r; s,1-s]. (Rows summing to one.)

tic % start a clock to see how long the whole thing takes

% The steady state distribution for X is

px0=@(r,s)s./(r+s); % probability that X=0 (low concentration)
px1=@(r,s)r./(r+s); % probability that X=1 (high concentration)

% The binary entropy function is 

phi2=@(p)(p.*log2(1./p)+(1-p).*log2(1./(1-p))); % entropy is measured in bits

% The entropy rate of X is 

HX=@(r,s)px0(r,s).*phi2(r)+px1(r,s).*phi2(s); % standard entropy rate for 2-state Markov process

%% Check
% default
%rvec=linspace(0,1,201); % r-grid for plotting
%svec=linspace(0,1,200); % s-grid for plotting
% to compare with Andrew's numerical simulations:
load ahi09alo01b05.mat
rvec=rr;
svec=ss;
MI_monte_carlo_Eckford=z';
clear rr ss z

[rplot,splot]=meshgrid(rvec,svec);
HXplot=HX(rplot,splot);
figure
[c,h]=contour(rplot,splot,HXplot);
clabel(c,h);
axis equal,axis tight,axis([0 1 0 1])
colorbar
set(gca,'FontSize',20)

%% The joint process. 
% (X-index shifted by 1 to match notation in our paper, which was chosen to
% match the notation in the Berger papers.  The joint Markov process is
% then (X(t+1),Y(t))->(X(t+2),Y(t+1)).
%
% For notation we use X=0(Low) or X=1(High) and Y=0(Unbound) or Y=1(Bound).
%
% The output Y has transition probability Y(t)=0->Y(t+1)=1 that depends on
% the value of X(t+1).  We assume the transition probability
% Y(t)=1->Y(t+1)=0 is independent of X(t+1).  In the general case, we have the following.
% If X(t+1)=0 then Pr(Y(t+1)=1 | Y(t)=0) = alo, and Pr(Y(t+1)=0 | Y(t)=0) = 1-alo.
% If X(t+1)=1 then Pr(Y(t+1)=1 | Y(t)=0) = ahi, and Pr(Y(t+1)=0 | Y(t)=0) = 1-ahi.
% For all X, Pr(Y(t+1)=0 | Y(t)=1) = b, and Pr(Y(t+1)=1 | Y(t)=1) = 1-b.
%
% With this definition, the combined process Z(t)=(X(t+1),Y(t)) is a Markov
% process on four states:
% Z1=(X=0,Y=0)
% Z2=(X=0,Y=1)
% Z3=(X=1,Y=0)
% Z4=(X=1,Y=1)
%
% The transition matrix for Z is given by T (rows sum to 1)
T=@(r,s,alo,ahi,b)...
    [(1-r).*(1-alo),  (1-r).*alo,     r.*(1-alo),       r.*alo;
    (1-r).*b,           (1-r).*(1-b),  r.*b,               r.*(1-b);
    s.*(1-ahi),        s.*ahi,          (1-s).*(1-ahi), (1-s).*ahi;
    s.*b,                s.*(1-b),       (1-s).*b,         (1-s).*(1-b)];

% For future reference:
aloplot=.1; % nominal "low" binding rate
ahiplot=.9; % nominal "high" binding rate
bplot=.5; % nominal unbinding rate

% We will need the components of T one by one later.

% First Row of T:
TLU2LU=@(r,s,alo,ahi,b)(1-r).*(1-alo);
TLU2LB=@(r,s,alo,ahi,b)(1-r).*alo;
TLU2HU=@(r,s,alo,ahi,b)r.*(1-alo);
TLU2HB=@(r,s,alo,ahi,b)r.*alo;

% Second Row of T:
TLB2LU=@(r,s,alo,ahi,b)(1-r).*b;
TLB2LB=@(r,s,alo,ahi,b)(1-r).*(1-b);
TLB2HU=@(r,s,alo,ahi,b)r.*b;
TLB2HB=@(r,s,alo,ahi,b)r.*(1-b);

% Third Row of T:
THU2LU=@(r,s,alo,ahi,b)s.*(1-ahi);
THU2LB=@(r,s,alo,ahi,b)s.*ahi;
THU2HU=@(r,s,alo,ahi,b)(1-s).*(1-ahi);
THU2HB=@(r,s,alo,ahi,b)(1-s).*ahi;

% Fourth Row of T:
THB2LU=@(r,s,alo,ahi,b)s.*b;
THB2LB=@(r,s,alo,ahi,b)s.*(1-b);
THB2HU=@(r,s,alo,ahi,b)(1-s).*b;
THB2HB=@(r,s,alo,ahi,b)(1-s).*(1-b);

% To check: alternate definition of T.  It works! (2013-03-15 2:00 pm EDT)
% Now comment it out and use the original only.
%T=@(r,s,alo,ahi,b)...
%    [TLU2LU(r,s,alo,ahi,b),TLU2LB(r,s,alo,ahi,b),TLU2HU(r,s,alo,ahi,b),TLU2HB(r,s,alo,ahi,b);...
%    TLB2LU(r,s,alo,ahi,b),TLB2LB(r,s,alo,ahi,b),TLB2HU(r,s,alo,ahi,b),TLB2HB(r,s,alo,ahi,b);...
%    THU2LU(r,s,alo,ahi,b),THU2LB(r,s,alo,ahi,b),THU2HU(r,s,alo,ahi,b),THU2HB(r,s,alo,ahi,b);...
%    THB2LU(r,s,alo,ahi,b),THB2LB(r,s,alo,ahi,b),THB2HU(r,s,alo,ahi,b),THB2HB(r,s,alo,ahi,b)];

% Transition probability matrix in a different form:
% Pr[X3=x3,Y2=y2|X2=x2,Y1=y1], i.e. T(x2,y1->x3,y2), written as a function of x2,y1,x3,y2:
TT=@(r,s,alo,ahi,b,x2,y1,x3,y2)...
    ...% First Row of T:
    (1-x2).*(1-y1).*(1-x3).*(1-y2).*TLU2LU(r,s,alo,ahi,b)+...
    (1-x2).*(1-y1).*(1-x3).*y2.*TLU2LB(r,s,alo,ahi,b)+...
    (1-x2).*(1-y1).*x3.*(1-y2).*TLU2HU(r,s,alo,ahi,b)+...
    (1-x2).*(1-y1).*x3.*y2.*TLU2HB(r,s,alo,ahi,b)+...
    ...% Second Row of T:
    (1-x2).*y1.*(1-x3).*(1-y2).*TLB2LU(r,s,alo,ahi,b)+...
    (1-x2).*y1.*(1-x3).*y2.*TLB2LB(r,s,alo,ahi,b)+...
    (1-x2).*y1.*x3.*(1-y2).*TLB2HU(r,s,alo,ahi,b)+...
    (1-x2).*y1.*x3.*y2.*TLB2HB(r,s,alo,ahi,b)+...
    ...% Third Row of T:
    x2.*(1-y1).*(1-x3).*(1-y2).*THU2LU(r,s,alo,ahi,b)+...
    x2.*(1-y1).*(1-x3).*y2.*THU2LB(r,s,alo,ahi,b)+...
    x2.*(1-y1).*x3.*(1-y2).*THU2HU(r,s,alo,ahi,b)+...
    x2.*(1-y1).*x3.*y2.*THU2HB(r,s,alo,ahi,b)+...
    ...% Fourth Row of T:
    x2.*y1.*(1-x3).*(1-y2).*THB2LU(r,s,alo,ahi,b)+...
    x2.*y1.*(1-x3).*y2.*THB2LB(r,s,alo,ahi,b)+...
    x2.*y1.*x3.*(1-y2).*THB2HU(r,s,alo,ahi,b)+...
    x2.*y1.*x3.*y2.*THB2HB(r,s,alo,ahi,b);

%% The stationary distribution for Z is given by

abar=@(r,s,alo,ahi)(r*ahi + s*alo)./(r + s); % average of "a" over input ensemble
lambda=@(r,s)1-(r+s); % eigenvalue for convergence rate of 2 state Markov input process
% make sure r and s can be arrays, for plotting
% ZZ is the normalization constant for the stationary probability
% distribution.
ZZ=@(r,s,alo,ahi,b)...
   b*s.*(1-lambda(r,s)+(ahi+b)*lambda(r,s))+...
    s.*(lambda(r,s)*alo*(ahi+b)+(r+s).*abar(r,s,alo,ahi))+...
    b*r.*(1-lambda(r,s)+(alo+b)*lambda(r,s))+...
    r.*(lambda(r,s)*ahi*(alo+b)+(r+s).*abar(r,s,alo,ahi));

pxy00=@(r,s,alo,ahi,b)b*s.*(1-lambda(r,s)+(ahi+b)*lambda(r,s))./ZZ(r,s,alo,ahi,b);
pxy01=@(r,s,alo,ahi,b)s.*(lambda(r,s)*alo*(ahi+b)+(r+s).*abar(r,s,alo,ahi))./ZZ(r,s,alo,ahi,b);
pxy10=@(r,s,alo,ahi,b)b*r.*(1-lambda(r,s)+(alo+b)*lambda(r,s))./ZZ(r,s,alo,ahi,b);
pxy11=@(r,s,alo,ahi,b)r.*(lambda(r,s).*ahi*(alo+b)+(r+s).*abar(r,s,alo,ahi))./ZZ(r,s,alo,ahi,b);

%% test stationary distribution
commandwindow
disp('Checking stationary distribution code is consistent...')
for j=1:5
    r=rand;s=rand;alo=rand;ahi=rand;b=rand;
    pxy=[pxy00(r,s,alo,ahi,b),pxy01(r,s,alo,ahi,b),pxy10(r,s,alo,ahi,b),pxy11(r,s,alo,ahi,b)];
    disp(sum(pxy))
    disp([pxy;pxy*T(r,s,alo,ahi,b)]); % should be 1 and identical)
    pause(1)
end
clear pxy r s alo ahi b
disp('OK, at long last it works!  2013-03-15, 11:30 am EDT')

%% Entropy rate of (X,Y) together 
% In the paper's notation, this is the entropy of the process
% Z(t)=(X(t+1),Y(t)).  

% We will need the entropy of a four-component distribution.  The
% quaternary entropy function is (in bits)

phi4=@(p1,p2,p3,p4)...
    (p1.*log2(1./p1)+p2.*log2(1./p2)+p3.*log2(1./p3)+p4.*log2(1./p4)); 

HXY=@(r,s,alo,ahi,b)...
    pxy00(r,s,alo,ahi,b).*...
    phi4(TLU2LU(r,s,alo,ahi,b),TLU2LB(r,s,alo,ahi,b),TLU2HU(r,s,alo,ahi,b),TLU2HB(r,s,alo,ahi,b))...
    +...
    pxy01(r,s,alo,ahi,b).*...
    phi4(TLB2LU(r,s,alo,ahi,b),TLB2LB(r,s,alo,ahi,b),TLB2HU(r,s,alo,ahi,b),TLB2HB(r,s,alo,ahi,b))...
    +...
    pxy10(r,s,alo,ahi,b).*...
    phi4(THU2LU(r,s,alo,ahi,b),THU2LB(r,s,alo,ahi,b),THU2HU(r,s,alo,ahi,b),THU2HB(r,s,alo,ahi,b))...
    +...
    pxy11(r,s,alo,ahi,b).*...
    phi4(THB2LU(r,s,alo,ahi,b),THB2LB(r,s,alo,ahi,b),THB2HU(r,s,alo,ahi,b),THB2HB(r,s,alo,ahi,b));

%   Entries of "T": each row is a probability distribution of destinations.        
%   [TLU2LU(r,s,alo,ahi,b),TLU2LB(r,s,alo,ahi,b),TLU2HU(r,s,alo,ahi,b),TLU2HB(r,s,alo,ahi,b);...
%   TLB2LU(r,s,alo,ahi,b),TLB2LB(r,s,alo,ahi,b),TLB2HU(r,s,alo,ahi,b),TLB2HB(r,s,alo,ahi,b);...
%   THU2LU(r,s,alo,ahi,b),THU2LB(r,s,alo,ahi,b),THU2HU(r,s,alo,ahi,b),THU2HB(r,s,alo,ahi,b);...
%   THB2LU(r,s,alo,ahi,b),THB2LB(r,s,alo,ahi,b),THB2HU(r,s,alo,ahi,b),THB2HB(r,s,alo,ahi,b)];

%% plot HXY

HXYplot=HXY(rplot,splot,aloplot,ahiplot,bplot);
figure
[c,h]=contour(rplot,splot,HXYplot);
clabel(c,h);
axis equal,axis tight,axis([0 1 0 1])
colorbar
set(gca,'FontSize',20)
title('Joint Entropy Rate H(X,Y)','FontSize',20)

% Checks out.  Had to replace "*" with ".*" for r, s products to work
% properly.  PJT 2013-03-15 2:30 p.m.

%% The Mutual information is MI=H(X)+H(Y)-H(X,Y)
% 
% Now we begin following the notes from April 24, 2014, see
% projects/bioinfo/papers/pjthomas/capacity-binding/Capacity2StateMarkov.tex.
% We recursively define the following functions (recursive since An is
% obtained from A(n-1)) as follows:
% A<n>(x2,...,xn+1,y1,...,yn) is Pr[X2=x2,...,X(n+1)=x(n+1),Y1=y1,...,Yn=yn].
% BU<n>(y1,...,yn) is Pr[Y1=y1,...,Yn=yn].
% BL<n>(x2,y1,...,yn) is Pr[X2=x2,Y1=y1,...,Yn=yn].
% CU<n>(x2,...,xn+1,y1,...,yn) is Pr[X2=x2,...,X(n+1)=x(n+1) | Y1=y1,...,Yn=yn].
% CL<n>(x2,...,xn+1,y1,...,yn) is Pr[X2=x3,...,X(n+1)=x(n+1) | X2=x2,Y1=y1,...,Yn=yn].
% DU<n>() is 
% DL<n>() is 
% FU<n>() is 
% FL<n>() is 
% *** continue here!
% For example "BU4" would be the function " B " appearing in the 4-step
% upper bound calculation.  And "BL3" would be the function " B' "
% appearing in the 3-step lower bound calculation.  

%% Entropy of Y (single trial) Gives the simplest upper bound on H[Y]
py0=@(r,s,alo,ahi,b)pxy00(r,s,alo,ahi,b)+pxy10(r,s,alo,ahi,b);
py1=@(r,s,alo,ahi,b)pxy01(r,s,alo,ahi,b)+pxy11(r,s,alo,ahi,b);
HYUB0=@(r,s,alo,ahi,b)phi2(py0(r,s,alo,ahi,b));
HYcheck=@(r,s,alo,ahi,b)phi2(py1(r,s,alo,ahi,b)); % should be same as HY.

%Check construction
disp('Quick check that I constructed the entropy H[Y] (one step) correctly:')
r=rand(1,5);s=rand(1,5);alo=rand;ahi=rand;b=rand;
commandwindow
disp([HYUB0(r,s,alo,ahi,b);HYcheck(r,s,alo,ahi,b)])
clear r s alo ahi b
disp('OK, appears consistent.  Moving on...')

% plot HY
HYplot=HYUB0(rplot,splot,aloplot,ahiplot,bplot);
figure
[c,h]=contour(rplot,splot,HYplot);
clabel(c,h);
axis equal,axis tight,axis([0 1 0 1])
colorbar
set(gca,'FontSize',20)
shg

% Looks OK (2014-04-06)

%% Define the quantities An, Bn, Cn, Dn, Fn recursively for a sequence of upper bounds.

% Notation (see notes): x^n=(x1,x2,...,x<n>).  y^n=(y0,y1,...,y<n-1>)

%% A (used for both upper and lower bounds)

% A1(x1,y0) is the steady state joint probability distribution
A1=@(r,s,alo,ahi,b,x1,y0)...
    pxy00(r,s,alo,ahi,b).*(1-x1).*(1-y0)+...
    pxy01(r,s,alo,ahi,b).*(1-x1).*y0+...
    pxy10(r,s,alo,ahi,b).*x1.*(1-y0)+...
    pxy11(r,s,alo,ahi,b).*x1.*y0;

% A2(x1,x2,y0,y1) is the steady state joint 2-step distribution
A2=@(r,s,alo,ahi,b,x1,x2,y0,y1)A1(r,s,alo,ahi,b,x1,y0).*TT(r,s,alo,ahi,b,x1,y0,x2,y1);

% An(x1,...,xn,y0,...,y<n-1>) is the n-step steady state distribution
A3=@(r,s,alo,ahi,b,x1,x2,x3,y0,y1,y2)...
    A2(r,s,alo,ahi,b,x1,x2,y0,y1).*...
    TT(r,s,alo,ahi,b,x2,y1,x3,y2);
A4=@(r,s,alo,ahi,b,x1,x2,x3,x4,y0,y1,y2,y3)...
    A3(r,s,alo,ahi,b,x1,x2,x3,y0,y1,y2).*...
    TT(r,s,alo,ahi,b,x3,y2,x4,y3);
A5=@(r,s,alo,ahi,b,x1,x2,x3,x4,x5,y0,y1,y2,y3,y4)...
    A4(r,s,alo,ahi,b,x1,x2,x3,x4,y0,y1,y2,y3).*...
    TT(r,s,alo,ahi,b,x4,y3,x5,y4);

% and so on.

%% B (used for upper bound) 

% B1(y0) is the steady state distribution of y.  
% Bn(y0,...,y<n-1>) is the n-step joint steady state distribution of y. 
B1=@(r,s,alo,ahi,b,y0)...
    A1(r,s,alo,ahi,b,0,y0)+...
    A1(r,s,alo,ahi,b,1,y0); 
B2=@(r,s,alo,ahi,b,y0,y1)...
    A2(r,s,alo,ahi,b,0,0,y0,y1)+...
    A2(r,s,alo,ahi,b,0,1,y0,y1)+...
    A2(r,s,alo,ahi,b,1,0,y0,y1)+...
    A2(r,s,alo,ahi,b,1,1,y0,y1);
B3=@(r,s,alo,ahi,b,y0,y1,y2)...
    A3(r,s,alo,ahi,b,0,0,0,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,0,0,1,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,0,1,0,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,0,1,1,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,1,0,0,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,1,0,1,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,1,1,0,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,1,1,1,y0,y1,y2);
B4=@(r,s,alo,ahi,b,y0,y1,y2,y3)...
    A4(r,s,alo,ahi,b,0,0,0,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,0,0,0,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,0,0,1,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,0,0,1,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,0,1,0,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,0,1,0,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,0,1,1,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,0,1,1,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,1,0,0,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,1,0,0,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,1,0,1,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,1,0,1,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,1,1,0,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,1,1,0,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,1,1,1,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,1,1,1,1,y0,y1,y2,y3);
B5=@(r,s,alo,ahi,b,y0,y1,y2,y3,y4)...    
    A5(r,s,alo,ahi,b,0,0,0,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,0,0,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,0,0,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,0,0,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,0,1,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,0,1,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,0,1,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,0,1,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,1,0,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,1,0,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,1,0,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,1,0,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,1,1,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,1,1,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,1,1,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,0,1,1,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,0,0,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,0,0,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,0,0,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,0,0,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,0,1,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,0,1,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,0,1,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,0,1,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,1,0,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,1,0,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,1,0,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,1,0,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,1,1,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,1,1,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,1,1,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,1,1,1,1,1,y0,y1,y2,y3,y4);

%% BL (used for lower bound) 
% Same arguments as B, above, with argument x1 (the first x value) added.

B1L=@(r,s,alo,ahi,b,x1,y0)...
    A1(r,s,alo,ahi,b,x1,y0);

B2L=@(r,s,alo,ahi,b,x1,y0,y1)...
    A2(r,s,alo,ahi,b,x1,0,y0,y1)+...
    A2(r,s,alo,ahi,b,x1,1,y0,y1);

B3L=@(r,s,alo,ahi,b,x1,y0,y1,y2)...
    A3(r,s,alo,ahi,b,x1,0,0,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,x1,0,1,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,x1,1,0,y0,y1,y2)+...
    A3(r,s,alo,ahi,b,x1,1,1,y0,y1,y2);

B4L=@(r,s,alo,ahi,b,x1,y0,y1,y2,y3)...
    A4(r,s,alo,ahi,b,x1,0,0,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,x1,0,0,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,x1,0,1,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,x1,0,1,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,x1,1,0,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,x1,1,0,1,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,x1,1,1,0,y0,y1,y2,y3)+...
    A4(r,s,alo,ahi,b,x1,1,1,1,y0,y1,y2,y3);

B5L=@(r,s,alo,ahi,b,x1,y0,y1,y2,y3,y4)...
    A5(r,s,alo,ahi,b,x1,0,0,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,0,0,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,0,0,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,0,0,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,0,1,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,0,1,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,0,1,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,0,1,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,1,0,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,1,0,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,1,0,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,1,0,1,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,1,1,0,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,1,1,0,1,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,1,1,1,0,y0,y1,y2,y3,y4)+...
    A5(r,s,alo,ahi,b,x1,1,1,1,1,y0,y1,y2,y3,y4);

%% C (as used in upper bound)
% C1(x1,y0) is the Bayes' rule term
C1=@(r,s,alo,ahi,b,x1,y0)...
    A1(r,s,alo,ahi,b,x1,y0)./...
    B1(r,s,alo,ahi,b,y0);
C2=@(r,s,alo,ahi,b,x1,x2,y0,y1)...
    A2(r,s,alo,ahi,b,x1,x2,y0,y1)./...
    B2(r,s,alo,ahi,b,y0,y1);
C3=@(r,s,alo,ahi,b,x1,x2,x3,y0,y1,y2)...
    A3(r,s,alo,ahi,b,x1,x2,x3,y0,y1,y2)./...
    B3(r,s,alo,ahi,b,y0,y1,y2);
C4=@(r,s,alo,ahi,b,x1,x2,x3,x4,y0,y1,y2,y3)...
    A4(r,s,alo,ahi,b,x1,x2,x3,x4,y0,y1,y2,y3)./...
    B4(r,s,alo,ahi,b,y0,y1,y2,y3);
C5=@(r,s,alo,ahi,b,x1,x2,x3,x4,x5,y0,y1,y2,y3,y4)...
    A5(r,s,alo,ahi,b,x1,x2,x3,x4,x5,y0,y1,y2,y3,y4)./...
    B5(r,s,alo,ahi,b,y0,y1,y2,y3,y4);

%% CL (as used in lower bound)
% C1L(x1,y0) is the Bayes' rule term
C1L=@(r,s,alo,ahi,b,x1,y0)...
    A1(r,s,alo,ahi,b,x1,y0)./...
    B1L(r,s,alo,ahi,b,x1,y0);
C2L=@(r,s,alo,ahi,b,x1,x2,y0,y1)...
    A2(r,s,alo,ahi,b,x1,x2,y0,y1)./...
    B2L(r,s,alo,ahi,b,x1,y0,y1);
C3L=@(r,s,alo,ahi,b,x1,x2,x3,y0,y1,y2)...
    A3(r,s,alo,ahi,b,x1,x2,x3,y0,y1,y2)./...
    B3L(r,s,alo,ahi,b,x1,y0,y1,y2);
C4L=@(r,s,alo,ahi,b,x1,x2,x3,x4,y0,y1,y2,y3)...
    A4(r,s,alo,ahi,b,x1,x2,x3,x4,y0,y1,y2,y3)./...
    B4L(r,s,alo,ahi,b,x1,y0,y1,y2,y3);
C5L=@(r,s,alo,ahi,b,x1,x2,x3,x4,x5,y0,y1,y2,y3,y4)...
    A5(r,s,alo,ahi,b,x1,x2,x3,x4,x5,y0,y1,y2,y3,y4)./...
    B5L(r,s,alo,ahi,b,x1,y0,y1,y2,y3,y4);

%% D (as used in upper bound)

D1=@(r,s,alo,ahi,b,x2,y0,y1)...
    TT(r,s,alo,ahi,b,0,y0,x2,y1).*C1(r,s,alo,ahi,b,0,y0)+...
    TT(r,s,alo,ahi,b,1,y0,x2,y1).*C1(r,s,alo,ahi,b,1,y0);

D2=@(r,s,alo,ahi,b,x3,y0,y1,y2)... % note "0/1" in TT matches LAST "0/1" in C2 
    TT(r,s,alo,ahi,b,0,y1,x3,y2).*C2(r,s,alo,ahi,b,0,0,y0,y1)+...
    TT(r,s,alo,ahi,b,1,y1,x3,y2).*C2(r,s,alo,ahi,b,0,1,y0,y1)+...
    TT(r,s,alo,ahi,b,0,y1,x3,y2).*C2(r,s,alo,ahi,b,1,0,y0,y1)+...
    TT(r,s,alo,ahi,b,1,y1,x3,y2).*C2(r,s,alo,ahi,b,1,1,y0,y1);

D3=@(r,s,alo,ahi,b,x4,y0,y1,y2,y3)...
    TT(r,s,alo,ahi,b,0,y2,x4,y3).*C3(r,s,alo,ahi,b,0,0,0,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,1,y2,x4,y3).*C3(r,s,alo,ahi,b,0,0,1,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,0,y2,x4,y3).*C3(r,s,alo,ahi,b,0,1,0,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,1,y2,x4,y3).*C3(r,s,alo,ahi,b,0,1,1,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,0,y2,x4,y3).*C3(r,s,alo,ahi,b,1,0,0,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,1,y2,x4,y3).*C3(r,s,alo,ahi,b,1,0,1,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,0,y2,x4,y3).*C3(r,s,alo,ahi,b,1,1,0,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,1,y2,x4,y3).*C3(r,s,alo,ahi,b,1,1,1,y0,y1,y2);

D4=@(r,s,alo,ahi,b,x5,y0,y1,y2,y3,y4)...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4(r,s,alo,ahi,b,0,0,0,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4(r,s,alo,ahi,b,0,0,0,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4(r,s,alo,ahi,b,0,0,1,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4(r,s,alo,ahi,b,0,0,1,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4(r,s,alo,ahi,b,0,1,0,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4(r,s,alo,ahi,b,0,1,0,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4(r,s,alo,ahi,b,0,1,1,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4(r,s,alo,ahi,b,0,1,1,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4(r,s,alo,ahi,b,1,0,0,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4(r,s,alo,ahi,b,1,0,0,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4(r,s,alo,ahi,b,1,0,1,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4(r,s,alo,ahi,b,1,0,1,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4(r,s,alo,ahi,b,1,1,0,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4(r,s,alo,ahi,b,1,1,0,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4(r,s,alo,ahi,b,1,1,1,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4(r,s,alo,ahi,b,1,1,1,1,y0,y1,y2,y3);

D5=@(r,s,alo,ahi,b,x6,y0,y1,y2,y3,y4,y5)...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,0,0,0,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,0,0,0,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,0,0,0,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,0,0,0,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,0,0,1,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,0,0,1,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,0,0,1,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,0,0,1,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,0,1,0,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,0,1,0,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,0,1,0,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,0,1,0,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,0,1,1,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,0,1,1,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,0,1,1,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,0,1,1,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,1,0,0,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,1,0,0,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,1,0,0,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,1,0,0,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,1,0,1,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,1,0,1,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,1,0,1,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,1,0,1,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,1,1,0,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,1,1,0,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,1,1,0,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,1,1,0,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,1,1,1,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,1,1,1,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5(r,s,alo,ahi,b,1,1,1,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5(r,s,alo,ahi,b,1,1,1,1,1,y0,y1,y2,y3,y4);

%% DL (as used in lower bound)

D1L=@(r,s,alo,ahi,b,x1,x2,y0,y1)...
    TT(r,s,alo,ahi,b,x1,y0,x2,y1).*C1L(r,s,alo,ahi,b,x1,y0);

D2L=@(r,s,alo,ahi,b,x1,x3,y0,y1,y2)... 
    TT(r,s,alo,ahi,b,0,y1,x3,y2).*C2L(r,s,alo,ahi,b,x1,0,y0,y1)+...
    TT(r,s,alo,ahi,b,1,y1,x3,y2).*C2L(r,s,alo,ahi,b,x1,1,y0,y1);

D3L=@(r,s,alo,ahi,b,x1,x4,y0,y1,y2,y3)...% note "0/1" in TT matches LAST "0/1" in C3L 
    TT(r,s,alo,ahi,b,0,y2,x4,y3).*C3L(r,s,alo,ahi,b,x1,0,0,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,1,y2,x4,y3).*C3L(r,s,alo,ahi,b,x1,0,1,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,0,y2,x4,y3).*C3L(r,s,alo,ahi,b,x1,1,0,y0,y1,y2)+...
    TT(r,s,alo,ahi,b,1,y2,x4,y3).*C3L(r,s,alo,ahi,b,x1,1,1,y0,y1,y2);

D4L=@(r,s,alo,ahi,b,x1,x5,y0,y1,y2,y3,y4)...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4L(r,s,alo,ahi,b,x1,0,0,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4L(r,s,alo,ahi,b,x1,0,0,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4L(r,s,alo,ahi,b,x1,0,1,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4L(r,s,alo,ahi,b,x1,0,1,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4L(r,s,alo,ahi,b,x1,1,0,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4L(r,s,alo,ahi,b,x1,1,0,1,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,0,y3,x5,y4).*C4L(r,s,alo,ahi,b,x1,1,1,0,y0,y1,y2,y3)+...
    TT(r,s,alo,ahi,b,1,y3,x5,y4).*C4L(r,s,alo,ahi,b,x1,1,1,1,y0,y1,y2,y3);

D5L=@(r,s,alo,ahi,b,x1,x6,y0,y1,y2,y3,y4,y5)...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,0,0,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,0,0,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,0,0,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,0,0,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,0,1,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,0,1,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,0,1,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,0,1,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,1,0,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,1,0,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,1,0,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,1,0,1,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,1,1,0,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,1,1,0,1,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,0,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,1,1,1,0,y0,y1,y2,y3,y4)+...
    TT(r,s,alo,ahi,b,1,y4,x6,y5).*C5L(r,s,alo,ahi,b,x1,1,1,1,1,y0,y1,y2,y3,y4);

%% F (as used in upper bound)

F1=@(r,s,alo,ahi,b,y0,y1)...
    D1(r,s,alo,ahi,b,0,y0,y1)+...
    D1(r,s,alo,ahi,b,1,y0,y1);

F2=@(r,s,alo,ahi,b,y0,y1,y2)...
    D2(r,s,alo,ahi,b,0,y0,y1,y2)+...
    D2(r,s,alo,ahi,b,1,y0,y1,y2);

F3=@(r,s,alo,ahi,b,y0,y1,y2,y3)...
    D3(r,s,alo,ahi,b,0,y0,y1,y2,y3)+...
    D3(r,s,alo,ahi,b,1,y0,y1,y2,y3);

F4=@(r,s,alo,ahi,b,y0,y1,y2,y3,y4)...
    D4(r,s,alo,ahi,b,0,y0,y1,y2,y3,y4)+...
    D4(r,s,alo,ahi,b,1,y0,y1,y2,y3,y4);

F5=@(r,s,alo,ahi,b,y0,y1,y2,y3,y4,y5)...
    D5(r,s,alo,ahi,b,0,y0,y1,y2,y3,y4,y5)+...
    D5(r,s,alo,ahi,b,1,y0,y1,y2,y3,y4,y5);

%% FL (as used in lower bound)

F1L=@(r,s,alo,ahi,b,x1,y0,y1)...
    D1L(r,s,alo,ahi,b,x1,0,y0,y1)+...
    D1L(r,s,alo,ahi,b,x1,1,y0,y1);

F2L=@(r,s,alo,ahi,b,x1,y0,y1,y2)...
    D2L(r,s,alo,ahi,b,x1,0,y0,y1,y2)+...
    D2L(r,s,alo,ahi,b,x1,1,y0,y1,y2);

F3L=@(r,s,alo,ahi,b,x1,y0,y1,y2,y3)...
    D3L(r,s,alo,ahi,b,x1,0,y0,y1,y2,y3)+...
    D3L(r,s,alo,ahi,b,x1,1,y0,y1,y2,y3);

F4L=@(r,s,alo,ahi,b,x1,y0,y1,y2,y3,y4)...
    D4L(r,s,alo,ahi,b,x1,0,y0,y1,y2,y3,y4)+...
    D4L(r,s,alo,ahi,b,x1,1,y0,y1,y2,y3,y4);

F5L=@(r,s,alo,ahi,b,x1,y0,y1,y2,y3,y4,y5)...
    D5L(r,s,alo,ahi,b,x1,0,y0,y1,y2,y3,y4,y5)+...
    D5L(r,s,alo,ahi,b,x1,1,y0,y1,y2,y3,y4,y5);

%% Upper bounds on the Y-sequence entropy

% 2014-05-15
% Found a mistake? Last argument of Fn should be yn, which should be fixed,
% not the first argument after the parameters.
% The next block of commented code is the original, which I think had this
% mistake.  
% The following block of code is corrected.

% HYUB1=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
%     B1(r,s,alo,ahi,b,0).*phi2(F1(r,s,alo,ahi,b,1,0))+...
%     B1(r,s,alo,ahi,b,1).*phi2(F1(r,s,alo,ahi,b,1,1));

HYUB1=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B1(r,s,alo,ahi,b,0).*phi2(F1(r,s,alo,ahi,b,0,1))+...
    B1(r,s,alo,ahi,b,1).*phi2(F1(r,s,alo,ahi,b,1,1));

% HYUB2=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
%     B2(r,s,alo,ahi,b,0,0).*phi2(F2(r,s,alo,ahi,b,1,0,0))+...
%     B2(r,s,alo,ahi,b,0,1).*phi2(F2(r,s,alo,ahi,b,1,0,1))+...
%     B2(r,s,alo,ahi,b,1,0).*phi2(F2(r,s,alo,ahi,b,1,1,0))+...
%     B2(r,s,alo,ahi,b,1,1).*phi2(F2(r,s,alo,ahi,b,1,1,1));

HYUB2=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B2(r,s,alo,ahi,b,0,0).*phi2(F2(r,s,alo,ahi,b,0,0,1))+...
    B2(r,s,alo,ahi,b,0,1).*phi2(F2(r,s,alo,ahi,b,0,1,1))+...
    B2(r,s,alo,ahi,b,1,0).*phi2(F2(r,s,alo,ahi,b,1,0,1))+...
    B2(r,s,alo,ahi,b,1,1).*phi2(F2(r,s,alo,ahi,b,1,1,1));

% HYUB3=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
%     B3(r,s,alo,ahi,b,0,0,0).*phi2(F3(r,s,alo,ahi,b,1,0,0,0))+...
%     B3(r,s,alo,ahi,b,0,0,1).*phi2(F3(r,s,alo,ahi,b,1,0,0,1))+...
%     B3(r,s,alo,ahi,b,0,1,0).*phi2(F3(r,s,alo,ahi,b,1,0,1,0))+...
%     B3(r,s,alo,ahi,b,0,1,1).*phi2(F3(r,s,alo,ahi,b,1,0,1,1))+...
%     B3(r,s,alo,ahi,b,1,0,0).*phi2(F3(r,s,alo,ahi,b,1,1,0,0))+...
%     B3(r,s,alo,ahi,b,1,0,1).*phi2(F3(r,s,alo,ahi,b,1,1,0,1))+...
%     B3(r,s,alo,ahi,b,1,1,0).*phi2(F3(r,s,alo,ahi,b,1,1,1,0))+...
%     B3(r,s,alo,ahi,b,1,1,1).*phi2(F3(r,s,alo,ahi,b,1,1,1,1));

HYUB3=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B3(r,s,alo,ahi,b,0,0,0).*phi2(F3(r,s,alo,ahi,b,0,0,0,1))+...
    B3(r,s,alo,ahi,b,0,0,1).*phi2(F3(r,s,alo,ahi,b,0,0,1,1))+...
    B3(r,s,alo,ahi,b,0,1,0).*phi2(F3(r,s,alo,ahi,b,0,1,0,1))+...
    B3(r,s,alo,ahi,b,0,1,1).*phi2(F3(r,s,alo,ahi,b,0,1,1,1))+...
    B3(r,s,alo,ahi,b,1,0,0).*phi2(F3(r,s,alo,ahi,b,1,0,0,1))+...
    B3(r,s,alo,ahi,b,1,0,1).*phi2(F3(r,s,alo,ahi,b,1,0,1,1))+...
    B3(r,s,alo,ahi,b,1,1,0).*phi2(F3(r,s,alo,ahi,b,1,1,0,1))+...
    B3(r,s,alo,ahi,b,1,1,1).*phi2(F3(r,s,alo,ahi,b,1,1,1,1));

% HYUB4=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
%     B4(r,s,alo,ahi,b,0,0,0,0).*phi2(F4(r,s,alo,ahi,b,1,0,0,0,0))+...
%     B4(r,s,alo,ahi,b,0,0,0,1).*phi2(F4(r,s,alo,ahi,b,1,0,0,0,1))+...
%     B4(r,s,alo,ahi,b,0,0,1,0).*phi2(F4(r,s,alo,ahi,b,1,0,0,1,0))+...
%     B4(r,s,alo,ahi,b,0,0,1,1).*phi2(F4(r,s,alo,ahi,b,1,0,0,1,1))+...
%     B4(r,s,alo,ahi,b,0,1,0,0).*phi2(F4(r,s,alo,ahi,b,1,0,1,0,0))+...
%     B4(r,s,alo,ahi,b,0,1,0,1).*phi2(F4(r,s,alo,ahi,b,1,0,1,0,1))+...
%     B4(r,s,alo,ahi,b,0,1,1,0).*phi2(F4(r,s,alo,ahi,b,1,0,1,1,0))+...
%     B4(r,s,alo,ahi,b,0,1,1,1).*phi2(F4(r,s,alo,ahi,b,1,0,1,1,1))+...
%     B4(r,s,alo,ahi,b,1,0,0,0).*phi2(F4(r,s,alo,ahi,b,1,1,0,0,0))+...
%     B4(r,s,alo,ahi,b,1,0,0,1).*phi2(F4(r,s,alo,ahi,b,1,1,0,0,1))+...
%     B4(r,s,alo,ahi,b,1,0,1,0).*phi2(F4(r,s,alo,ahi,b,1,1,0,1,0))+...
%     B4(r,s,alo,ahi,b,1,0,1,1).*phi2(F4(r,s,alo,ahi,b,1,1,0,1,1))+...
%     B4(r,s,alo,ahi,b,1,1,0,0).*phi2(F4(r,s,alo,ahi,b,1,1,1,0,0))+...
%     B4(r,s,alo,ahi,b,1,1,0,1).*phi2(F4(r,s,alo,ahi,b,1,1,1,0,1))+...
%     B4(r,s,alo,ahi,b,1,1,1,0).*phi2(F4(r,s,alo,ahi,b,1,1,1,1,0))+...
%     B4(r,s,alo,ahi,b,1,1,1,1).*phi2(F4(r,s,alo,ahi,b,1,1,1,1,1));

HYUB4=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B4(r,s,alo,ahi,b,0,0,0,0).*phi2(F4(r,s,alo,ahi,b,0,0,0,0,1))+...
    B4(r,s,alo,ahi,b,0,0,0,1).*phi2(F4(r,s,alo,ahi,b,0,0,0,1,1))+...
    B4(r,s,alo,ahi,b,0,0,1,0).*phi2(F4(r,s,alo,ahi,b,0,0,1,0,1))+...
    B4(r,s,alo,ahi,b,0,0,1,1).*phi2(F4(r,s,alo,ahi,b,0,0,1,1,1))+...
    B4(r,s,alo,ahi,b,0,1,0,0).*phi2(F4(r,s,alo,ahi,b,0,1,0,0,1))+...
    B4(r,s,alo,ahi,b,0,1,0,1).*phi2(F4(r,s,alo,ahi,b,0,1,0,1,1))+...
    B4(r,s,alo,ahi,b,0,1,1,0).*phi2(F4(r,s,alo,ahi,b,0,1,1,0,1))+...
    B4(r,s,alo,ahi,b,0,1,1,1).*phi2(F4(r,s,alo,ahi,b,0,1,1,1,1))+...
    B4(r,s,alo,ahi,b,1,0,0,0).*phi2(F4(r,s,alo,ahi,b,1,0,0,0,1))+...
    B4(r,s,alo,ahi,b,1,0,0,1).*phi2(F4(r,s,alo,ahi,b,1,0,0,1,1))+...
    B4(r,s,alo,ahi,b,1,0,1,0).*phi2(F4(r,s,alo,ahi,b,1,0,1,0,1))+...
    B4(r,s,alo,ahi,b,1,0,1,1).*phi2(F4(r,s,alo,ahi,b,1,0,1,1,1))+...
    B4(r,s,alo,ahi,b,1,1,0,0).*phi2(F4(r,s,alo,ahi,b,1,1,0,0,1))+...
    B4(r,s,alo,ahi,b,1,1,0,1).*phi2(F4(r,s,alo,ahi,b,1,1,0,1,1))+...
    B4(r,s,alo,ahi,b,1,1,1,0).*phi2(F4(r,s,alo,ahi,b,1,1,1,0,1))+...
    B4(r,s,alo,ahi,b,1,1,1,1).*phi2(F4(r,s,alo,ahi,b,1,1,1,1,1));

% HYUB5=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
%     B5(r,s,alo,ahi,b,0,0,0,0,0).*phi2(F5(r,s,alo,ahi,b,1,0,0,0,0,0))+...
%     B5(r,s,alo,ahi,b,0,0,0,0,1).*phi2(F5(r,s,alo,ahi,b,1,0,0,0,0,1))+...
%     B5(r,s,alo,ahi,b,0,0,0,1,0).*phi2(F5(r,s,alo,ahi,b,1,0,0,0,1,0))+...
%     B5(r,s,alo,ahi,b,0,0,0,1,1).*phi2(F5(r,s,alo,ahi,b,1,0,0,0,1,1))+...
%     B5(r,s,alo,ahi,b,0,0,1,0,0).*phi2(F5(r,s,alo,ahi,b,1,0,0,1,0,0))+...
%     B5(r,s,alo,ahi,b,0,0,1,0,1).*phi2(F5(r,s,alo,ahi,b,1,0,0,1,0,1))+...
%     B5(r,s,alo,ahi,b,0,0,1,1,0).*phi2(F5(r,s,alo,ahi,b,1,0,0,1,1,0))+...
%     B5(r,s,alo,ahi,b,0,0,1,1,1).*phi2(F5(r,s,alo,ahi,b,1,0,0,1,1,1))+...
%     B5(r,s,alo,ahi,b,0,1,0,0,0).*phi2(F5(r,s,alo,ahi,b,1,0,1,0,0,0))+...
%     B5(r,s,alo,ahi,b,0,1,0,0,1).*phi2(F5(r,s,alo,ahi,b,1,0,1,0,0,1))+...
%     B5(r,s,alo,ahi,b,0,1,0,1,0).*phi2(F5(r,s,alo,ahi,b,1,0,1,0,1,0))+...
%     B5(r,s,alo,ahi,b,0,1,0,1,1).*phi2(F5(r,s,alo,ahi,b,1,0,1,0,1,1))+...
%     B5(r,s,alo,ahi,b,0,1,1,0,0).*phi2(F5(r,s,alo,ahi,b,1,0,1,1,0,0))+...
%     B5(r,s,alo,ahi,b,0,1,1,0,1).*phi2(F5(r,s,alo,ahi,b,1,0,1,1,0,1))+...
%     B5(r,s,alo,ahi,b,0,1,1,1,0).*phi2(F5(r,s,alo,ahi,b,1,0,1,1,1,0))+...
%     B5(r,s,alo,ahi,b,0,1,1,1,1).*phi2(F5(r,s,alo,ahi,b,1,0,1,1,1,1))+...
%     B5(r,s,alo,ahi,b,1,0,0,0,0).*phi2(F5(r,s,alo,ahi,b,1,1,0,0,0,0))+...
%     B5(r,s,alo,ahi,b,1,0,0,0,1).*phi2(F5(r,s,alo,ahi,b,1,1,0,0,0,1))+...
%     B5(r,s,alo,ahi,b,1,0,0,1,0).*phi2(F5(r,s,alo,ahi,b,1,1,0,0,1,0))+...
%     B5(r,s,alo,ahi,b,1,0,0,1,1).*phi2(F5(r,s,alo,ahi,b,1,1,0,0,1,1))+...
%     B5(r,s,alo,ahi,b,1,0,1,0,0).*phi2(F5(r,s,alo,ahi,b,1,1,0,1,0,0))+...
%     B5(r,s,alo,ahi,b,1,0,1,0,1).*phi2(F5(r,s,alo,ahi,b,1,1,0,1,0,1))+...
%     B5(r,s,alo,ahi,b,1,0,1,1,0).*phi2(F5(r,s,alo,ahi,b,1,1,0,1,1,0))+...
%     B5(r,s,alo,ahi,b,1,0,1,1,1).*phi2(F5(r,s,alo,ahi,b,1,1,0,1,1,1))+...
%     B5(r,s,alo,ahi,b,1,1,0,0,0).*phi2(F5(r,s,alo,ahi,b,1,1,1,0,0,0))+...
%     B5(r,s,alo,ahi,b,1,1,0,0,1).*phi2(F5(r,s,alo,ahi,b,1,1,1,0,0,1))+...
%     B5(r,s,alo,ahi,b,1,1,0,1,0).*phi2(F5(r,s,alo,ahi,b,1,1,1,0,1,0))+...
%     B5(r,s,alo,ahi,b,1,1,0,1,1).*phi2(F5(r,s,alo,ahi,b,1,1,1,0,1,1))+...
%     B5(r,s,alo,ahi,b,1,1,1,0,0).*phi2(F5(r,s,alo,ahi,b,1,1,1,1,0,0))+...
%     B5(r,s,alo,ahi,b,1,1,1,0,1).*phi2(F5(r,s,alo,ahi,b,1,1,1,1,0,1))+...
%     B5(r,s,alo,ahi,b,1,1,1,1,0).*phi2(F5(r,s,alo,ahi,b,1,1,1,1,1,0))+...
%     B5(r,s,alo,ahi,b,1,1,1,1,1).*phi2(F5(r,s,alo,ahi,b,1,1,1,1,1,1));

HYUB5=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B5(r,s,alo,ahi,b,0,0,0,0,0).*phi2(F5(r,s,alo,ahi,b,0,0,0,0,0,1))+...
    B5(r,s,alo,ahi,b,0,0,0,0,1).*phi2(F5(r,s,alo,ahi,b,0,0,0,0,1,1))+...
    B5(r,s,alo,ahi,b,0,0,0,1,0).*phi2(F5(r,s,alo,ahi,b,0,0,0,1,0,1))+...
    B5(r,s,alo,ahi,b,0,0,0,1,1).*phi2(F5(r,s,alo,ahi,b,0,0,0,1,1,1))+...
    B5(r,s,alo,ahi,b,0,0,1,0,0).*phi2(F5(r,s,alo,ahi,b,0,0,1,0,0,1))+...
    B5(r,s,alo,ahi,b,0,0,1,0,1).*phi2(F5(r,s,alo,ahi,b,0,0,1,0,1,1))+...
    B5(r,s,alo,ahi,b,0,0,1,1,0).*phi2(F5(r,s,alo,ahi,b,0,0,1,1,0,1))+...
    B5(r,s,alo,ahi,b,0,0,1,1,1).*phi2(F5(r,s,alo,ahi,b,0,0,1,1,1,1))+...
    B5(r,s,alo,ahi,b,0,1,0,0,0).*phi2(F5(r,s,alo,ahi,b,0,1,0,0,0,1))+...
    B5(r,s,alo,ahi,b,0,1,0,0,1).*phi2(F5(r,s,alo,ahi,b,0,1,0,0,1,1))+...
    B5(r,s,alo,ahi,b,0,1,0,1,0).*phi2(F5(r,s,alo,ahi,b,0,1,0,1,0,1))+...
    B5(r,s,alo,ahi,b,0,1,0,1,1).*phi2(F5(r,s,alo,ahi,b,0,1,0,1,1,1))+...
    B5(r,s,alo,ahi,b,0,1,1,0,0).*phi2(F5(r,s,alo,ahi,b,0,1,1,0,0,1))+...
    B5(r,s,alo,ahi,b,0,1,1,0,1).*phi2(F5(r,s,alo,ahi,b,0,1,1,0,1,1))+...
    B5(r,s,alo,ahi,b,0,1,1,1,0).*phi2(F5(r,s,alo,ahi,b,0,1,1,1,0,1))+...
    B5(r,s,alo,ahi,b,0,1,1,1,1).*phi2(F5(r,s,alo,ahi,b,0,1,1,1,1,1))+...
    B5(r,s,alo,ahi,b,1,0,0,0,0).*phi2(F5(r,s,alo,ahi,b,1,0,0,0,0,1))+...
    B5(r,s,alo,ahi,b,1,0,0,0,1).*phi2(F5(r,s,alo,ahi,b,1,0,0,0,1,1))+...
    B5(r,s,alo,ahi,b,1,0,0,1,0).*phi2(F5(r,s,alo,ahi,b,1,0,0,1,0,1))+...
    B5(r,s,alo,ahi,b,1,0,0,1,1).*phi2(F5(r,s,alo,ahi,b,1,0,0,1,1,1))+...
    B5(r,s,alo,ahi,b,1,0,1,0,0).*phi2(F5(r,s,alo,ahi,b,1,0,1,0,0,1))+...
    B5(r,s,alo,ahi,b,1,0,1,0,1).*phi2(F5(r,s,alo,ahi,b,1,0,1,0,1,1))+...
    B5(r,s,alo,ahi,b,1,0,1,1,0).*phi2(F5(r,s,alo,ahi,b,1,0,1,1,0,1))+...
    B5(r,s,alo,ahi,b,1,0,1,1,1).*phi2(F5(r,s,alo,ahi,b,1,0,1,1,1,1))+...
    B5(r,s,alo,ahi,b,1,1,0,0,0).*phi2(F5(r,s,alo,ahi,b,1,1,0,0,0,1))+...
    B5(r,s,alo,ahi,b,1,1,0,0,1).*phi2(F5(r,s,alo,ahi,b,1,1,0,0,1,1))+...
    B5(r,s,alo,ahi,b,1,1,0,1,0).*phi2(F5(r,s,alo,ahi,b,1,1,0,1,0,1))+...
    B5(r,s,alo,ahi,b,1,1,0,1,1).*phi2(F5(r,s,alo,ahi,b,1,1,0,1,1,1))+...
    B5(r,s,alo,ahi,b,1,1,1,0,0).*phi2(F5(r,s,alo,ahi,b,1,1,1,0,0,1))+...
    B5(r,s,alo,ahi,b,1,1,1,0,1).*phi2(F5(r,s,alo,ahi,b,1,1,1,0,1,1))+...
    B5(r,s,alo,ahi,b,1,1,1,1,0).*phi2(F5(r,s,alo,ahi,b,1,1,1,1,0,1))+...
    B5(r,s,alo,ahi,b,1,1,1,1,1).*phi2(F5(r,s,alo,ahi,b,1,1,1,1,1,1));

%% Lower bounds on the Y-sequence entropy

HYLB1=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B1L(r,s,alo,ahi,b,0,0).*phi2(F1L(r,s,alo,ahi,b,0,0,1))+...
    B1L(r,s,alo,ahi,b,0,1).*phi2(F1L(r,s,alo,ahi,b,0,1,1))+...
    B1L(r,s,alo,ahi,b,1,0).*phi2(F1L(r,s,alo,ahi,b,1,0,1))+...
    B1L(r,s,alo,ahi,b,1,1).*phi2(F1L(r,s,alo,ahi,b,1,1,1));
    
HYLB2=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B2L(r,s,alo,ahi,b,0,0,0).*phi2(F2L(r,s,alo,ahi,b,0,0,0,1))+...
    B2L(r,s,alo,ahi,b,0,0,1).*phi2(F2L(r,s,alo,ahi,b,0,0,1,1))+...
    B2L(r,s,alo,ahi,b,0,1,0).*phi2(F2L(r,s,alo,ahi,b,0,1,0,1))+...
    B2L(r,s,alo,ahi,b,0,1,1).*phi2(F2L(r,s,alo,ahi,b,0,1,1,1))+...
    B2L(r,s,alo,ahi,b,1,0,0).*phi2(F2L(r,s,alo,ahi,b,1,0,0,1))+...
    B2L(r,s,alo,ahi,b,1,0,1).*phi2(F2L(r,s,alo,ahi,b,1,0,1,1))+...
    B2L(r,s,alo,ahi,b,1,1,0).*phi2(F2L(r,s,alo,ahi,b,1,1,0,1))+...
    B2L(r,s,alo,ahi,b,1,1,1).*phi2(F2L(r,s,alo,ahi,b,1,1,1,1));

HYLB3=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B3L(r,s,alo,ahi,b,0,0,0,0).*phi2(F3L(r,s,alo,ahi,b,0,0,0,0,1))+...
    B3L(r,s,alo,ahi,b,0,0,0,1).*phi2(F3L(r,s,alo,ahi,b,0,0,0,1,1))+...
    B3L(r,s,alo,ahi,b,0,0,1,0).*phi2(F3L(r,s,alo,ahi,b,0,0,1,0,1))+...
    B3L(r,s,alo,ahi,b,0,0,1,1).*phi2(F3L(r,s,alo,ahi,b,0,0,1,1,1))+...
    B3L(r,s,alo,ahi,b,0,1,0,0).*phi2(F3L(r,s,alo,ahi,b,0,1,0,0,1))+...
    B3L(r,s,alo,ahi,b,0,1,0,1).*phi2(F3L(r,s,alo,ahi,b,0,1,0,1,1))+...
    B3L(r,s,alo,ahi,b,0,1,1,0).*phi2(F3L(r,s,alo,ahi,b,0,1,1,0,1))+...
    B3L(r,s,alo,ahi,b,0,1,1,1).*phi2(F3L(r,s,alo,ahi,b,0,1,1,1,1))+...
    B3L(r,s,alo,ahi,b,1,0,0,0).*phi2(F3L(r,s,alo,ahi,b,1,0,0,0,1))+...
    B3L(r,s,alo,ahi,b,1,0,0,1).*phi2(F3L(r,s,alo,ahi,b,1,0,0,1,1))+...
    B3L(r,s,alo,ahi,b,1,0,1,0).*phi2(F3L(r,s,alo,ahi,b,1,0,1,0,1))+...
    B3L(r,s,alo,ahi,b,1,0,1,1).*phi2(F3L(r,s,alo,ahi,b,1,0,1,1,1))+...
    B3L(r,s,alo,ahi,b,1,1,0,0).*phi2(F3L(r,s,alo,ahi,b,1,1,0,0,1))+...
    B3L(r,s,alo,ahi,b,1,1,0,1).*phi2(F3L(r,s,alo,ahi,b,1,1,0,1,1))+...
    B3L(r,s,alo,ahi,b,1,1,1,0).*phi2(F3L(r,s,alo,ahi,b,1,1,1,0,1))+...
    B3L(r,s,alo,ahi,b,1,1,1,1).*phi2(F3L(r,s,alo,ahi,b,1,1,1,1,1));

HYLB4=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B4L(r,s,alo,ahi,b,0,0,0,0,0).*phi2(F4L(r,s,alo,ahi,b,0,0,0,0,0,1))+...
    B4L(r,s,alo,ahi,b,0,0,0,0,1).*phi2(F4L(r,s,alo,ahi,b,0,0,0,0,1,1))+...
    B4L(r,s,alo,ahi,b,0,0,0,1,0).*phi2(F4L(r,s,alo,ahi,b,0,0,0,1,0,1))+...
    B4L(r,s,alo,ahi,b,0,0,0,1,1).*phi2(F4L(r,s,alo,ahi,b,0,0,0,1,1,1))+...
    B4L(r,s,alo,ahi,b,0,0,1,0,0).*phi2(F4L(r,s,alo,ahi,b,0,0,1,0,0,1))+...
    B4L(r,s,alo,ahi,b,0,0,1,0,1).*phi2(F4L(r,s,alo,ahi,b,0,0,1,0,1,1))+...
    B4L(r,s,alo,ahi,b,0,0,1,1,0).*phi2(F4L(r,s,alo,ahi,b,0,0,1,1,0,1))+...
    B4L(r,s,alo,ahi,b,0,0,1,1,1).*phi2(F4L(r,s,alo,ahi,b,0,0,1,1,1,1))+...
    B4L(r,s,alo,ahi,b,0,1,0,0,0).*phi2(F4L(r,s,alo,ahi,b,0,1,0,0,0,1))+...
    B4L(r,s,alo,ahi,b,0,1,0,0,1).*phi2(F4L(r,s,alo,ahi,b,0,1,0,0,1,1))+...
    B4L(r,s,alo,ahi,b,0,1,0,1,0).*phi2(F4L(r,s,alo,ahi,b,0,1,0,1,0,1))+...
    B4L(r,s,alo,ahi,b,0,1,0,1,1).*phi2(F4L(r,s,alo,ahi,b,0,1,0,1,1,1))+...
    B4L(r,s,alo,ahi,b,0,1,1,0,0).*phi2(F4L(r,s,alo,ahi,b,0,1,1,0,0,1))+...
    B4L(r,s,alo,ahi,b,0,1,1,0,1).*phi2(F4L(r,s,alo,ahi,b,0,1,1,0,1,1))+...
    B4L(r,s,alo,ahi,b,0,1,1,1,0).*phi2(F4L(r,s,alo,ahi,b,0,1,1,1,0,1))+...
    B4L(r,s,alo,ahi,b,0,1,1,1,1).*phi2(F4L(r,s,alo,ahi,b,0,1,1,1,1,1))+...
    B4L(r,s,alo,ahi,b,1,0,0,0,0).*phi2(F4L(r,s,alo,ahi,b,1,0,0,0,0,1))+...
    B4L(r,s,alo,ahi,b,1,0,0,0,1).*phi2(F4L(r,s,alo,ahi,b,1,0,0,0,1,1))+...
    B4L(r,s,alo,ahi,b,1,0,0,1,0).*phi2(F4L(r,s,alo,ahi,b,1,0,0,1,0,1))+...
    B4L(r,s,alo,ahi,b,1,0,0,1,1).*phi2(F4L(r,s,alo,ahi,b,1,0,0,1,1,1))+...
    B4L(r,s,alo,ahi,b,1,0,1,0,0).*phi2(F4L(r,s,alo,ahi,b,1,0,1,0,0,1))+...
    B4L(r,s,alo,ahi,b,1,0,1,0,1).*phi2(F4L(r,s,alo,ahi,b,1,0,1,0,1,1))+...
    B4L(r,s,alo,ahi,b,1,0,1,1,0).*phi2(F4L(r,s,alo,ahi,b,1,0,1,1,0,1))+...
    B4L(r,s,alo,ahi,b,1,0,1,1,1).*phi2(F4L(r,s,alo,ahi,b,1,0,1,1,1,1))+...
    B4L(r,s,alo,ahi,b,1,1,0,0,0).*phi2(F4L(r,s,alo,ahi,b,1,1,0,0,0,1))+...
    B4L(r,s,alo,ahi,b,1,1,0,0,1).*phi2(F4L(r,s,alo,ahi,b,1,1,0,0,1,1))+...
    B4L(r,s,alo,ahi,b,1,1,0,1,0).*phi2(F4L(r,s,alo,ahi,b,1,1,0,1,0,1))+...
    B4L(r,s,alo,ahi,b,1,1,0,1,1).*phi2(F4L(r,s,alo,ahi,b,1,1,0,1,1,1))+...
    B4L(r,s,alo,ahi,b,1,1,1,0,0).*phi2(F4L(r,s,alo,ahi,b,1,1,1,0,0,1))+...
    B4L(r,s,alo,ahi,b,1,1,1,0,1).*phi2(F4L(r,s,alo,ahi,b,1,1,1,0,1,1))+...
    B4L(r,s,alo,ahi,b,1,1,1,1,0).*phi2(F4L(r,s,alo,ahi,b,1,1,1,1,0,1))+...
    B4L(r,s,alo,ahi,b,1,1,1,1,1).*phi2(F4L(r,s,alo,ahi,b,1,1,1,1,1,1));

HYLB5=@(r,s,alo,ahi,b)... % Note first "1" after parameters in phi2 is fixed
    B5L(r,s,alo,ahi,b,0,0,0,0,0,0).*phi2(F5L(r,s,alo,ahi,b,0,0,0,0,0,0,1))+...
    B5L(r,s,alo,ahi,b,0,0,0,0,0,1).*phi2(F5L(r,s,alo,ahi,b,0,0,0,0,0,1,1))+...
    B5L(r,s,alo,ahi,b,0,0,0,0,1,0).*phi2(F5L(r,s,alo,ahi,b,0,0,0,0,1,0,1))+...
    B5L(r,s,alo,ahi,b,0,0,0,0,1,1).*phi2(F5L(r,s,alo,ahi,b,0,0,0,0,1,1,1))+...
    B5L(r,s,alo,ahi,b,0,0,0,1,0,0).*phi2(F5L(r,s,alo,ahi,b,0,0,0,1,0,0,1))+...
    B5L(r,s,alo,ahi,b,0,0,0,1,0,1).*phi2(F5L(r,s,alo,ahi,b,0,0,0,1,0,1,1))+...
    B5L(r,s,alo,ahi,b,0,0,0,1,1,0).*phi2(F5L(r,s,alo,ahi,b,0,0,0,1,1,0,1))+...
    B5L(r,s,alo,ahi,b,0,0,0,1,1,1).*phi2(F5L(r,s,alo,ahi,b,0,0,0,1,1,1,1))+...
    B5L(r,s,alo,ahi,b,0,0,1,0,0,0).*phi2(F5L(r,s,alo,ahi,b,0,0,1,0,0,0,1))+...
    B5L(r,s,alo,ahi,b,0,0,1,0,0,1).*phi2(F5L(r,s,alo,ahi,b,0,0,1,0,0,1,1))+...
    B5L(r,s,alo,ahi,b,0,0,1,0,1,0).*phi2(F5L(r,s,alo,ahi,b,0,0,1,0,1,0,1))+...
    B5L(r,s,alo,ahi,b,0,0,1,0,1,1).*phi2(F5L(r,s,alo,ahi,b,0,0,1,0,1,1,1))+...
    B5L(r,s,alo,ahi,b,0,0,1,1,0,0).*phi2(F5L(r,s,alo,ahi,b,0,0,1,1,0,0,1))+...
    B5L(r,s,alo,ahi,b,0,0,1,1,0,1).*phi2(F5L(r,s,alo,ahi,b,0,0,1,1,0,1,1))+...
    B5L(r,s,alo,ahi,b,0,0,1,1,1,0).*phi2(F5L(r,s,alo,ahi,b,0,0,1,1,1,0,1))+...
    B5L(r,s,alo,ahi,b,0,0,1,1,1,1).*phi2(F5L(r,s,alo,ahi,b,0,0,1,1,1,1,1))+...
    B5L(r,s,alo,ahi,b,0,1,0,0,0,0).*phi2(F5L(r,s,alo,ahi,b,0,1,0,0,0,0,1))+...
    B5L(r,s,alo,ahi,b,0,1,0,0,0,1).*phi2(F5L(r,s,alo,ahi,b,0,1,0,0,0,1,1))+...
    B5L(r,s,alo,ahi,b,0,1,0,0,1,0).*phi2(F5L(r,s,alo,ahi,b,0,1,0,0,1,0,1))+...
    B5L(r,s,alo,ahi,b,0,1,0,0,1,1).*phi2(F5L(r,s,alo,ahi,b,0,1,0,0,1,1,1))+...
    B5L(r,s,alo,ahi,b,0,1,0,1,0,0).*phi2(F5L(r,s,alo,ahi,b,0,1,0,1,0,0,1))+...
    B5L(r,s,alo,ahi,b,0,1,0,1,0,1).*phi2(F5L(r,s,alo,ahi,b,0,1,0,1,0,1,1))+...
    B5L(r,s,alo,ahi,b,0,1,0,1,1,0).*phi2(F5L(r,s,alo,ahi,b,0,1,0,1,1,0,1))+...
    B5L(r,s,alo,ahi,b,0,1,0,1,1,1).*phi2(F5L(r,s,alo,ahi,b,0,1,0,1,1,1,1))+...
    B5L(r,s,alo,ahi,b,0,1,1,0,0,0).*phi2(F5L(r,s,alo,ahi,b,0,1,1,0,0,0,1))+...
    B5L(r,s,alo,ahi,b,0,1,1,0,0,1).*phi2(F5L(r,s,alo,ahi,b,0,1,1,0,0,1,1))+...
    B5L(r,s,alo,ahi,b,0,1,1,0,1,0).*phi2(F5L(r,s,alo,ahi,b,0,1,1,0,1,0,1))+...
    B5L(r,s,alo,ahi,b,0,1,1,0,1,1).*phi2(F5L(r,s,alo,ahi,b,0,1,1,0,1,1,1))+...
    B5L(r,s,alo,ahi,b,0,1,1,1,0,0).*phi2(F5L(r,s,alo,ahi,b,0,1,1,1,0,0,1))+...
    B5L(r,s,alo,ahi,b,0,1,1,1,0,1).*phi2(F5L(r,s,alo,ahi,b,0,1,1,1,0,1,1))+...
    B5L(r,s,alo,ahi,b,0,1,1,1,1,0).*phi2(F5L(r,s,alo,ahi,b,0,1,1,1,1,0,1))+...
    B5L(r,s,alo,ahi,b,0,1,1,1,1,1).*phi2(F5L(r,s,alo,ahi,b,0,1,1,1,1,1,1))+...
    B5L(r,s,alo,ahi,b,1,0,0,0,0,0).*phi2(F5L(r,s,alo,ahi,b,1,0,0,0,0,0,1))+...
    B5L(r,s,alo,ahi,b,1,0,0,0,0,1).*phi2(F5L(r,s,alo,ahi,b,1,0,0,0,0,1,1))+...
    B5L(r,s,alo,ahi,b,1,0,0,0,1,0).*phi2(F5L(r,s,alo,ahi,b,1,0,0,0,1,0,1))+...
    B5L(r,s,alo,ahi,b,1,0,0,0,1,1).*phi2(F5L(r,s,alo,ahi,b,1,0,0,0,1,1,1))+...
    B5L(r,s,alo,ahi,b,1,0,0,1,0,0).*phi2(F5L(r,s,alo,ahi,b,1,0,0,1,0,0,1))+...
    B5L(r,s,alo,ahi,b,1,0,0,1,0,1).*phi2(F5L(r,s,alo,ahi,b,1,0,0,1,0,1,1))+...
    B5L(r,s,alo,ahi,b,1,0,0,1,1,0).*phi2(F5L(r,s,alo,ahi,b,1,0,0,1,1,0,1))+...
    B5L(r,s,alo,ahi,b,1,0,0,1,1,1).*phi2(F5L(r,s,alo,ahi,b,1,0,0,1,1,1,1))+...
    B5L(r,s,alo,ahi,b,1,0,1,0,0,0).*phi2(F5L(r,s,alo,ahi,b,1,0,1,0,0,0,1))+...
    B5L(r,s,alo,ahi,b,1,0,1,0,0,1).*phi2(F5L(r,s,alo,ahi,b,1,0,1,0,0,1,1))+...
    B5L(r,s,alo,ahi,b,1,0,1,0,1,0).*phi2(F5L(r,s,alo,ahi,b,1,0,1,0,1,0,1))+...
    B5L(r,s,alo,ahi,b,1,0,1,0,1,1).*phi2(F5L(r,s,alo,ahi,b,1,0,1,0,1,1,1))+...
    B5L(r,s,alo,ahi,b,1,0,1,1,0,0).*phi2(F5L(r,s,alo,ahi,b,1,0,1,1,0,0,1))+...
    B5L(r,s,alo,ahi,b,1,0,1,1,0,1).*phi2(F5L(r,s,alo,ahi,b,1,0,1,1,0,1,1))+...
    B5L(r,s,alo,ahi,b,1,0,1,1,1,0).*phi2(F5L(r,s,alo,ahi,b,1,0,1,1,1,0,1))+...
    B5L(r,s,alo,ahi,b,1,0,1,1,1,1).*phi2(F5L(r,s,alo,ahi,b,1,0,1,1,1,1,1))+...
    B5L(r,s,alo,ahi,b,1,1,0,0,0,0).*phi2(F5L(r,s,alo,ahi,b,1,1,0,0,0,0,1))+...
    B5L(r,s,alo,ahi,b,1,1,0,0,0,1).*phi2(F5L(r,s,alo,ahi,b,1,1,0,0,0,1,1))+...
    B5L(r,s,alo,ahi,b,1,1,0,0,1,0).*phi2(F5L(r,s,alo,ahi,b,1,1,0,0,1,0,1))+...
    B5L(r,s,alo,ahi,b,1,1,0,0,1,1).*phi2(F5L(r,s,alo,ahi,b,1,1,0,0,1,1,1))+...
    B5L(r,s,alo,ahi,b,1,1,0,1,0,0).*phi2(F5L(r,s,alo,ahi,b,1,1,0,1,0,0,1))+...
    B5L(r,s,alo,ahi,b,1,1,0,1,0,1).*phi2(F5L(r,s,alo,ahi,b,1,1,0,1,0,1,1))+...
    B5L(r,s,alo,ahi,b,1,1,0,1,1,0).*phi2(F5L(r,s,alo,ahi,b,1,1,0,1,1,0,1))+...
    B5L(r,s,alo,ahi,b,1,1,0,1,1,1).*phi2(F5L(r,s,alo,ahi,b,1,1,0,1,1,1,1))+...
    B5L(r,s,alo,ahi,b,1,1,1,0,0,0).*phi2(F5L(r,s,alo,ahi,b,1,1,1,0,0,0,1))+...
    B5L(r,s,alo,ahi,b,1,1,1,0,0,1).*phi2(F5L(r,s,alo,ahi,b,1,1,1,0,0,1,1))+...
    B5L(r,s,alo,ahi,b,1,1,1,0,1,0).*phi2(F5L(r,s,alo,ahi,b,1,1,1,0,1,0,1))+...
    B5L(r,s,alo,ahi,b,1,1,1,0,1,1).*phi2(F5L(r,s,alo,ahi,b,1,1,1,0,1,1,1))+...
    B5L(r,s,alo,ahi,b,1,1,1,1,0,0).*phi2(F5L(r,s,alo,ahi,b,1,1,1,1,0,0,1))+...
    B5L(r,s,alo,ahi,b,1,1,1,1,0,1).*phi2(F5L(r,s,alo,ahi,b,1,1,1,1,0,1,1))+...
    B5L(r,s,alo,ahi,b,1,1,1,1,1,0).*phi2(F5L(r,s,alo,ahi,b,1,1,1,1,1,0,1))+...
    B5L(r,s,alo,ahi,b,1,1,1,1,1,1).*phi2(F5L(r,s,alo,ahi,b,1,1,1,1,1,1,1));

%% Upper bounds on the mutual information

MIUB1=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYUB1(r,s,alo,ahi,b),HX(r,s));
MIUB2=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYUB2(r,s,alo,ahi,b),HX(r,s));
MIUB3=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYUB3(r,s,alo,ahi,b),HX(r,s));
MIUB4=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYUB4(r,s,alo,ahi,b),HX(r,s));
MIUB5=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYUB5(r,s,alo,ahi,b),HX(r,s));

%% Lower bounds on the mutual information

MILB1=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYLB1(r,s,alo,ahi,b),HX(r,s));
MILB2=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYLB2(r,s,alo,ahi,b),HX(r,s));
MILB3=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYLB3(r,s,alo,ahi,b),HX(r,s));
MILB4=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYLB4(r,s,alo,ahi,b),HX(r,s));
MILB5=@(r,s,alo,ahi,b)min(HX(r,s)-HXY(r,s,alo,ahi,b)+HYLB5(r,s,alo,ahi,b),HX(r,s));

%% Plots

% better check one at a time!

% Plot UB1
MIUB1plot=MIUB1(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MIUB1plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Upper Bound 1: min(H(X)-H(X,Y)+H(Y1|Y0),H(X))    ','FontSize',20),shg
% Note: this upper bound is the famous ridge...

%% Plot LB1
MILB1plot=MILB1(rplot,splot,aloplot,ahiplot,bplot);figure
%[c,h]=contour(rplot,splot,MILB1plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
%title('Lower Bound 1: min(H(X)-H(X,Y)+H(Y1|X1,Y0),H(X))    ','FontSize',20),shg
% Note: this lower bound is identically zero.  Do not attempt to plot.

%% Plot UB2
MIUB2plot=MIUB2(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MIUB2plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Upper Bound 2: min(H(X)-H(X,Y)+H(Y2|Y0,Y1),H(X))    ','FontSize',20),shg

%% Plot LB2
MILB2plot=MILB2(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MILB2plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Lower Bound 2: min(H(X)-H(X,Y)+H(Y2|X1,Y0,Y1),H(X))    ','FontSize',20),shg

%% Plot UB3
MIUB3plot=MIUB3(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MIUB3plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Upper Bound 3: min(H(X)-H(X,Y)+H(Y3|Y0,Y1,Y2),H(X))    ','FontSize',20),shg

%% Plot LB3
MILB3plot=MILB3(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MILB3plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Lower Bound 3: min(H(X)-H(X,Y)+H(Y3|X1,Y0,Y1,Y2),H(X))    ','FontSize',20),shg

%% Plot UB4
MIUB4plot=MIUB4(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MIUB4plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Upper Bound 4: min(H(X)-H(X,Y)+H(Y4|Y0,Y1,Y2,Y3),H(X))    ','FontSize',20),shg

%% Plot LB4
MILB4plot=MILB4(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MILB4plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Lower Bound 4: min(H(X)-H(X,Y)+H(Y4|X1,Y0,Y1,Y2,Y3),H(X))    ','FontSize',20),shg

%% Plot UB5
MIUB5plot=MIUB5(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MIUB5plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Upper Bound 5: min(H(X)-H(X,Y)+H(Y5|Y0,Y1,Y2,Y3,Y4),H(X))    ','FontSize',20),shg

%% Plot LB5
MILB5plot=MILB5(rplot,splot,aloplot,ahiplot,bplot);figure
[c,h]=contour(rplot,splot,MILB5plot);clabel(c,h);axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Lower Bound 5: min(H(X)-H(X,Y)+H(Y5|X1,Y0,Y1,Y2,Y3,Y4),H(X))    ','FontSize',20),shg

%%  Compare

figure
[c_lower,h_lower]=contour(rplot,splot,MILB5plot);clabel(c_lower,h_lower);
hold on
[c_upper,h_upper]=contour(rplot,splot,MIUB5plot);clabel(c_upper,h_upper);
axis equal,axis tight,axis([0 1 0 1]),colorbar,set(gca,'FontSize',20)
title('Lower Bound 5 and Upper Bound 5   ','FontSize',20),shg
print -dpdf MI_upper_lower_5deep.pdf

totaltime=toc;
save(['Capacity2StateMarkovNstep-',date])
